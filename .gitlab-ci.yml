# Define stages
stages:
  - test-code
  - build
  - scan
  - test-sonar
  - sonar

# For Unit test
test-job:
  stage: test-code
  image: node:lts-alpine
  script:
    - npm ci
    - npm run test:ci
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*run all.*/
  # Tags are used to select the runner that will execute the job
  # In this case it is a self-hosted runner with the tag "Project_Runner"
  tags:
    - Project_Runner

# For Docker build
build-job:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--host=tcp://0.0.0.0:2375", "--tls=false"]
  script:
    - docker login registry.gitlab.com -u $GITLAB_USERNAME -p $PAT_TOKEN
    - docker build -t registry.gitlab.com/testing382203/intern:$CI_COMMIT_SHORT_SHA . 
    - docker push registry.gitlab.com/testing382203/intern:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*run all.*/  
  tags:
    - Project_Runner

# For Container Scanning with Trivy
image_scan:
  stage: scan
  image:
    name: docker.io/aquasec/trivy:latest
    # Entrypoint allows to override the default entrypoint of the image. From "trivy trivy --version" -> To "trivy --version" 
    entrypoint: [""]
  variables:
    GIT_STRATEGY: none
    # Gitlab registry login
    TRIVY_USERNAME: "$GITLAB_USERNAME"
    TRIVY_PASSWORD: "$PAT_TOKEN"
    TRIVY_AUTH_URL: "$CI_REGISTRY"
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: ".trivycache/"
    FULL_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  script:
    - trivy --version
    # update vulnerabilities db
    - time trivy image --download-db-only
    # Builds report and puts it in the default workdir $CI_PROJECT_DIR, so `artifacts:` can take it from there
    - time trivy image --exit-code 0 --format template --template "@/contrib/gitlab.tpl"
        --output "$CI_PROJECT_DIR/gl-container-scanning-report.json" "$FULL_IMAGE_NAME"
    # Prints full report
    - time trivy image --exit-code 0 "$FULL_IMAGE_NAME"
    # Fail on critical vulnerabilities
    - time trivy image --exit-code 1 --severity CRITICAL "$FULL_IMAGE_NAME"
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*run all.*/  
  tags:
    - Project_Runner


check-sonarqube:
  stage: test-sonar
  tags:
    - Project_Runner
  image: alpine
  script:
    - apk add --no-cache curl
    - echo "Pinging SonarQube at ${SONAR_HOST_URL}"
    - curl -I "${SONAR_HOST_URL}"
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*test sonar.*/

sonarscanner-job:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/   
  script: 
    #- sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.login="${SONAR_TOKEN}"
    - sonar-scanner
      -Dsonar.projectKey=Intern-Project
      -Dsonar.sources=.
      -Dsonar.host.url="${SONAR_HOST_URL}"
      -Dsonar.login="${SONAR_TOKEN}"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*run all.*/
  tags:
    - Project_Runner